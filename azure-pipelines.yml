name: Jenkins Agent Packer

strategy:
  matrix:
    Ubuntu:
      os: Ubuntu
      templatePath: jenkins-agent-ubuntu.pkr.hcl

pool:
  vmImage: 'ubuntu-latest'

steps:
  - checkout: self
  - task: riezebosch.Packer.PackerTool.PackerTool@0
    displayName: 'Install Packer'
    inputs:
      version: 1.7.4

  - task: riezebosch.Packer.Packer.Packer@1
    displayName: 'Validate'
    inputs:
      templatePath: $(templatePath)
      command: validate
      azureSubscription: dts-management-prod-intsvc


  - task: riezebosch.Packer.Packer.Packer@1
    displayName: 'PR Build'
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/master'))
    inputs:
      templatePath: $(templatePath)
      variables: |
          jenkins_ssh_key=$(JENKINS_SSH_KEY)
      command: build
      azureSubscription: dts-management-prod-intsvc
      options: --only=azure-arm.no-publish

  - task: riezebosch.Packer.Packer.Packer@1
    displayName: 'Build and publish'
    condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/heads/master'))
    inputs:
      templatePath: $(templatePath)
      variables: |
          jenkins_ssh_key=$(JENKINS_SSH_KEY)
      command: build
      azureSubscription: dts-management-prod-intsvc
      options: --only=azure-arm.build-and-publish
